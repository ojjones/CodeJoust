<!doctype html>
<html>
<head>
	<script type="text/javascript" src="js/jquery.js"></script>
	<script type="text/javascript" src="js/bootstrap.js"></script>
	<script type="text/javascript" src="js/wsapi.js"></script>
	<script type="text/javascript" src="js/util.js"></script>
	<script src="ace/build/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
		jQuery(function($) {

			/* Web Socket State Constants */
			const CONNECTING = 0;
			const OPEN = 1;
			const CLOSING = 2;
			const CLOSED = 3;

			const START = 1;
			const STOP = 2;

			if (getParameterByName("game_id") == "" ||
				getParameterByName("team") == "" ||
				getParameterByName("problem") == "") {
				window.location = "/index.html";
				return;
			}

			var game_id = parseInt(getParameterByName("game_id"));
			var team_id = parseInt(getParameterByName("team"));
			var problem = getParameterByName("problem");

			$btnCompile = $("#btn-compile");
			$divProblemText = $("#div-problem-text");

			$(".team-id").text(team_id);
			$(".problem-title").text(problem);

			/******************************
			  IO Event Handlers
			 ******************************/

			initIOHandler = function(e) {
				$divProblemText.text(e.problem_text);
				editor.setValue(e.code_session);
			};

			startIOHandler = function(e) {
			};

			stopIOHandler = function(e) {
			};

			/******************************
			  Button Event Handlers
			 ******************************/

			compileBtnHandler = function() {
				$btnCompile.button("loading");
				editor.setReadOnly(true);
				$.ajax({
					type: "POST",
					url: "/compile",
					contentType: "application/json",
					dataType: "json",
					data: JSON.stringify({
						game_id: game_id,
						team: team_id,
						code: editor.getValue()
					}),
					success: function(data) {
						alert(data);
						$btnCompile.button("reset");
						editor.setReadOnly(false);
					},
					error: function() {
						alert("Something went wrong, blame bryce!");
						$btnCompile.button("reset");
						editor.setReadOnly(false);
					}
				});
			};

			$btnCompile.click(compileBtnHandler);

			var changeCount = 0;
			var editor = ace.edit("editor");
			editor.setTheme("ace/theme/monokai");
			editor.getSession().setMode("ace/mode/c_cpp");
			editor.getSession().on("change", function(e) {
				if (ws.readyState == OPEN) {
					changeCount += 1;
					if (changeCount % 1 == 0) {
						changeCount = 0;
						var msg = JSON.stringify(wsapi.TEAM_CODE_PUSH(game_id, team_id, editor.getValue()));
						ws.send(msg);
					}
				}
			});

			var ws = new WebSocket("ws://localhost:8080/team");

			ws.onbeforeunload = function(e) {
			};

			ws.onmessage = function(e) {
				data = JSON.parse(e.data);
				console.log(data);

				switch(data.type) {
					case wsapi.INIT_RES_ID:
						initIOHandler(data);
						break;
					case START:
						startIOHandler(data);
						break;
					case STOP:
						stopIOHandler(data);
						break;
					default:
						console.log(data);

				}
			};

			ws.onopen = function() {
				var msg = JSON.stringify(wsapi.INIT_REQ(game_id, team_id));
				console.log("Sending msg: " + msg);
				ws.send(msg);
			};

			ws.onclose = function(e) {
			};

		});
	</script>

	<link rel="stylesheet" href="css/bootstrap.css" />
	<style type="text/css">
		body {
			padding-top: 20px;
			padding-bottom: 40px;
			background-color: #eee;
		}

		#editor-container {
			height: 800px;
		}

		#editor {
			margin: 5px 0 0;
			position: absolute;
			top: 0;
			bottom: 0;
			left: 0;
			right: 0;
			font-size:24px;
		}
	</style>
</head>
<body>

	<div class="container">
		<div class="row">
			<h1><span class="problem-title">fizzbuzz</span> - Team <span class="team-id"></span></h1>
		</div>
		<div class="row">
			<button id="btn-compile" type="button" class="btn btn-primary btn-lg">Compile</button>
		</div>
		<div class="row">
			<div id="editor-container" class="col-md-12">
				<div id="editor"></div>
			</div>
		</div>
			<div class="clearfix"></div>
		<div class="row">
			<h2>Problem: <span class="problem-title">fizzbuzz<a/></h2>
			<div id="div-problem-text">
				<p>Write a program that prints the numbers from 1 to 100. But for multiples of three print 'Fizz' instead of the number and for the multiples of five print 'Buzz'. For numbers which are multiples of both three and five print 'FizzBuzz'.</p>
			</div>
		</div>
	</div>

</body>
</html>
